<tbody id="row-{{ item.id }}" x-data="{ notesOpen: false, diffOpen: false, rowOpen: {{ 'false' if item.qty == 0 and not item.notes and not item.excluded else 'true' }} }">

{% if item.excluded %}
<!-- Excluded row (greyed out, soft-deleted) -->
<tr class="border-b border-gray-200 {{ 'bg-red-50' if item.is_exclusion else 'bg-gray-100 opacity-50' }}">
    <!-- Row Number -->
    <td class="px-1 py-2 text-center text-xs text-gray-400 font-mono">
        {{ row_num | default('?') }}
    </td>

    <!-- Restore button -->
    <td class="px-1 py-2 text-center">
        <button type="button"
                title="Restore item"
                class="w-5 h-5 rounded flex items-center justify-center text-xs bg-green-100 text-green-600 hover:bg-green-200 hover:text-green-800"
                hx-post="/bid/item/{{ item.id }}/exclude"
                hx-target="#row-{{ item.id }}"
                hx-swap="outerHTML">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h10a5 5 0 010 10H9m4-10l-4-4m4 4l-4 4"/>
            </svg>
        </button>
    </td>

    <!-- Exclusion toggle -->
    <td class="px-2 py-2 text-center">
        <button type="button"
                title="{{ 'Remove from exclusions' if item.is_exclusion else 'Add as exclusion on proposal' }}"
                class="w-5 h-5 rounded flex items-center justify-center text-xs
                       {% if item.is_exclusion %}bg-red-100 text-red-600 hover:bg-red-200{% else %}bg-gray-100 text-gray-400 hover:bg-red-50 hover:text-red-400{% endif %}"
                hx-post="/bid/item/{{ item.id }}/exclusion"
                hx-target="#row-{{ item.id }}"
                hx-swap="outerHTML">
            <span class="leading-none text-xs font-bold">E</span>
        </button>
    </td>

    <!-- Item Name -->
    <td class="px-3 py-2">
        {% if item.is_exclusion %}
        <span class="font-medium text-red-800">Excludes {{ item.name }}</span>
        {% else %}
        <span class="font-semibold text-gray-400 line-through">{{ item.name }}</span>
        {% endif %}
    </td>

    <!-- Quantity -->
    <td class="px-2 py-2 text-center text-sm text-gray-400">{{ format_number(item.qty) }}</td>

    <!-- UOM -->
    <td class="px-2 py-2 text-center text-sm text-gray-400">{{ item.uom }}</td>

    <!-- Remaining columns -->
    <td colspan="3" class="px-2 py-2 text-right text-sm text-gray-400 line-through">
        {{ format_currency(item.row_total) }}
    </td>
</tr>

{% else %}

<!-- Collapsed row (shown when rowOpen is false) -->
<tr x-show="!rowOpen" class="border-b border-gray-100 {{ 'bg-red-50' if item.is_exclusion else 'bg-gray-50' }} text-gray-400 hover:bg-gray-100">
    <!-- Row Number -->
    <td class="px-1 py-1 text-center text-xs font-mono">
        {{ row_num | default('?') }}
    </td>

    <!-- Expand Button -->
    <td class="px-1 py-1 text-center">
        <button type="button"
                @click.stop="rowOpen = true"
                class="w-5 h-5 rounded flex items-center justify-center text-xs bg-gray-100 text-gray-400 hover:bg-gray-200 hover:text-gray-600">
            <span class="leading-none">+</span>
        </button>
    </td>

    <!-- Exclusion toggle -->
    <td class="px-2 py-1 text-center">
        <button type="button"
                title="{{ 'Remove from exclusions' if item.is_exclusion else 'Add as exclusion on proposal' }}"
                class="w-5 h-5 rounded flex items-center justify-center text-xs
                       {% if item.is_exclusion %}bg-red-100 text-red-600 hover:bg-red-200{% else %}bg-gray-100 text-gray-400 hover:bg-red-50 hover:text-red-400{% endif %}"
                hx-post="/bid/item/{{ item.id }}/exclusion"
                hx-target="#row-{{ item.id }}"
                hx-swap="outerHTML"
                @click.stop>
            <span class="leading-none text-xs font-bold">E</span>
        </button>
    </td>

    <!-- Item Name (dimmed) -->
    <td class="px-3 py-1">
        {% if item.is_exclusion %}
        <span class="text-sm text-red-800 font-medium">Excludes {{ item.name }}</span>
        {% else %}
        <span class="text-sm text-gray-400">{{ item.name }}</span>
        {% endif %}
    </td>

    <!-- Quantity -->
    <td class="px-2 py-1 text-center text-xs">0</td>

    <!-- UOM -->
    <td class="px-2 py-1 text-center text-xs">{{ item.uom }}</td>

    <!-- Remaining columns collapsed -->
    <td colspan="3" class="px-2 py-1 text-right text-xs">&mdash;</td>
</tr>

<!-- Full row (shown when rowOpen is true) -->
<tr x-show="rowOpen" class="border-b border-gray-200 hover:bg-gray-50">
    <!-- Row Number -->
    <td class="px-1 py-2 text-center text-xs text-gray-400 font-mono">
        {{ row_num | default('?') }}
    </td>

    <!-- Expand/Collapse Notes -->
    <td class="px-1 py-2 text-center">
        {% if item.qty == 0 and not item.notes %}
        <!-- For empty rows: collapse button that hides the whole row -->
        <button type="button"
                @click="rowOpen = false; notesOpen = false"
                class="w-6 h-6 rounded flex items-center justify-center text-sm bg-gray-100 text-gray-500 hover:bg-gray-200">
            <span class="text-lg leading-none">&minus;</span>
        </button>
        {% else %}
        <!-- For rows with data: toggle notes -->
        <button type="button"
                @click="notesOpen = !notesOpen"
                class="w-6 h-6 rounded flex items-center justify-center text-sm transition-colors
                       {% if item.notes %}bg-blue-100 text-blue-600 hover:bg-blue-200{% else %}bg-gray-100 text-gray-500 hover:bg-gray-200{% endif %}"
                :class="notesOpen ? 'bg-blue-100 text-blue-600' : ''">
            <span x-show="!notesOpen" class="text-lg leading-none">+</span>
            <span x-show="notesOpen" class="text-lg leading-none">&minus;</span>
        </button>
        {% endif %}
    </td>

    <!-- Exclude button (X) -->
    <td class="px-2 py-2 text-center">
        <button type="button"
                title="Remove item"
                class="w-6 h-6 rounded flex items-center justify-center text-xs bg-red-50 text-red-400 hover:bg-red-100 hover:text-red-600"
                hx-post="/bid/item/{{ item.id }}/exclude"
                hx-target="#row-{{ item.id }}"
                hx-swap="outerHTML">
            <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
            </svg>
        </button>
    </td>

    <!-- Item Name -->
    <td class="px-3 py-2">
        <div class="flex items-center">
            <input type="text"
                   name="name"
                   value="{{ item.name }}"
                   class="font-semibold text-gray-900 bg-transparent border-b border-transparent hover:border-gray-300 focus:border-blue-500 focus:outline-none focus:bg-white px-1 py-0.5 w-full"
                   hx-post="/bid/item/{{ item.id }}/name"
                   hx-trigger="change"
                   hx-target="#row-{{ item.id }}"
                   hx-swap="outerHTML">
            {% if item.is_alternate %}
            <span class="ml-2 px-1.5 py-0.5 bg-yellow-100 text-yellow-700 text-xs rounded flex-shrink-0">ALT</span>
            {% endif %}
            {% if item.notes %}
            <svg class="w-4 h-4 ml-2 text-blue-500 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M18 13V5a2 2 0 00-2-2H4a2 2 0 00-2 2v8a2 2 0 002 2h3l3 3 3-3h3a2 2 0 002-2zM5 7a1 1 0 011-1h8a1 1 0 110 2H6a1 1 0 01-1-1zm1 3a1 1 0 100 2h3a1 1 0 100-2H6z" clip-rule="evenodd"/>
            </svg>
            {% endif %}
        </div>
    </td>

    <!-- Quantity -->
    <td class="px-2 py-2 text-center">
        <input type="text"
               name="qty"
               value="{{ format_number(item.qty) }}"
               class="w-20 px-2 py-1.5 text-center border border-gray-300 rounded bg-gray-50 text-sm focus:ring-2 focus:ring-blue-500 focus:bg-white"
               hx-post="/bid/item/{{ item.id }}/qty"
               hx-trigger="change"
               hx-target="#row-{{ item.id }}"
               hx-swap="outerHTML">
    </td>

    <!-- UOM -->
    <td class="px-2 py-2 text-center">
        <input type="text"
               name="uom"
               value="{{ item.uom }}"
               class="w-14 px-1 py-0.5 text-center text-sm text-gray-600 bg-transparent border-b border-transparent hover:border-gray-300 focus:border-blue-500 focus:outline-none focus:bg-white"
               hx-post="/bid/item/{{ item.id }}/uom"
               hx-trigger="change"
               hx-target="#row-{{ item.id }}"
               hx-swap="outerHTML">
    </td>

    <!-- Unit Price -->
    <td class="px-2 py-2 text-center">
        <div class="flex items-center justify-center">
            <span class="mr-1 text-gray-600">$</span>
            <input type="text"
                   name="unit_price"
                   value="{{ format_currency_input(item.unit_price_base) }}"
                   class="w-20 px-2 py-1.5 text-center border border-gray-300 rounded bg-gray-50 text-sm focus:ring-2 focus:ring-blue-500 focus:bg-white"
                   hx-post="/bid/item/{{ item.id }}/price"
                   hx-trigger="change"
                   hx-target="#row-{{ item.id }}"
                   hx-swap="outerHTML">
        </div>
    </td>

    <!-- Difficulty Buttons with Absolute Add-Ons -->
    <td class="px-2 py-2">
        <div class="flex items-center justify-center gap-1">
            <div class="flex space-x-1">
                {% for d in [1, 2, 3, 4, 5] %}
                {% set add_at_level = item.difficulty_adders.get(d, 0) %}
                {% set price_at_level = item.unit_price_base + add_at_level %}
                <button type="button"
                        class="px-2 py-1 text-xs rounded border min-w-[45px]
                               {% if item.difficulty == d %}
                               bg-yellow-400 text-gray-900 border-yellow-500 font-semibold
                               {% else %}
                               bg-white text-gray-600 border-gray-300 hover:bg-gray-100
                               {% endif %}"
                        hx-post="/bid/item/{{ item.id }}/difficulty"
                        hx-vals='{"difficulty": {{ d }}}'
                        hx-target="#row-{{ item.id }}"
                        hx-swap="outerHTML">
                    ${{ "%.0f"|format(price_at_level) }}
                </button>
                {% endfor %}
            </div>
            <button type="button"
                    @click="diffOpen = !diffOpen"
                    class="w-5 h-5 rounded flex items-center justify-center text-xs transition-colors"
                    :class="diffOpen ? 'bg-yellow-100 text-yellow-700' : 'bg-gray-100 text-gray-400 hover:bg-gray-200 hover:text-gray-600'">
                <span x-show="!diffOpen" class="leading-none">+</span>
                <span x-show="diffOpen" class="leading-none">&minus;</span>
            </button>
        </div>
    </td>

    <!-- Row Total -->
    <td class="px-3 py-2 text-right font-bold text-gray-900">
        {{ format_currency(item.row_total) }}
    </td>
</tr>

<!-- Difficulty Adders Row (expandable) -->
<tr x-show="rowOpen && diffOpen" class="bg-yellow-50 border-b border-gray-200">
    <td colspan="7"></td>
    <td class="px-2 py-1.5">
        <div class="flex items-center gap-1 justify-center">
            {% for d in [1, 2, 3, 4, 5] %}
            <div class="flex items-center">
                <span class="text-gray-400 text-xs mr-0.5">$</span>
                <input type="text"
                       name="amount"
                       value="{{ format_currency_input(item.difficulty_adders.get(d, 0)) }}"
                       class="w-[45px] px-1 py-0.5 text-xs border border-gray-300 rounded bg-white text-center"
                       hx-post="/bid/item/{{ item.id }}/difficulty-add"
                       hx-vals='{"level": {{ d }}}'
                       hx-trigger="change"
                       hx-target="#row-{{ item.id }}"
                       hx-swap="outerHTML">
            </div>
            {% endfor %}
        </div>
    </td>
    <td></td>
</tr>

<!-- Notes Row (expandable) -->
<tr x-show="rowOpen && notesOpen" class="notes-row bg-blue-50 border-b border-gray-200">
    <td colspan="9" class="px-4 py-3">
        <div class="flex items-start gap-3">
            <svg class="w-5 h-5 text-blue-500 mt-1 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M18 13V5a2 2 0 00-2-2H4a2 2 0 00-2 2v8a2 2 0 002 2h3l3 3 3-3h3a2 2 0 002-2zM5 7a1 1 0 011-1h8a1 1 0 110 2H6a1 1 0 01-1-1zm1 3a1 1 0 100 2h3a1 1 0 100-2H6z" clip-rule="evenodd"/>
            </svg>
            <div class="flex-1">
                <label class="block text-sm font-medium text-gray-700 mb-1">Notes for {{ item.name }}</label>
                <textarea name="notes"
                          rows="2"
                          placeholder="Add notes about this line item..."
                          class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white"
                          hx-post="/bid/item/{{ item.id }}/notes"
                          hx-trigger="change"
                          hx-target="#row-{{ item.id }}"
                          hx-swap="outerHTML">{{ item.notes or '' }}</textarea>
            </div>
        </div>
    </td>
</tr>

{% endif %}
</tbody>
