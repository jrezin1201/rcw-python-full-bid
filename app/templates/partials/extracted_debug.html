{% if debug_payload and debug_payload.extraction %}
{% set extraction = debug_payload.extraction %}
{% set mapping = debug_payload.mapping %}
{% set catalog = debug_payload.catalog %}

<div class="space-y-6">
    <!-- Summary -->
    <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-4">
        <div class="bg-white rounded-lg shadow-sm p-4 border border-gray-100">
            <div class="text-xs text-gray-500">Rows Extracted</div>
            <div class="text-2xl font-semibold text-gray-900">
                {{ extraction.stats.rows_extracted if extraction.stats else 0 }}
                <span class="text-sm text-gray-500">/ {{ extraction.stats.rows_total if extraction.stats else 0 }}</span>
            </div>
            <div class="text-xs text-gray-400 mt-1">Ignored: {{ extraction.stats.rows_ignored if extraction.stats else 0 }}</div>
        </div>
        <div class="bg-white rounded-lg shadow-sm p-4 border border-gray-100">
            <div class="text-xs text-gray-500">Mapped Items</div>
            <div class="text-2xl font-semibold text-gray-900">
                {{ mapping.qa.stats.items_mapped if mapping and mapping.qa else 0 }}
            </div>
            <div class="text-xs text-gray-400 mt-1">Unmapped: {{ mapping.qa.stats.items_unmapped if mapping and mapping.qa else 0 }}</div>
        </div>
        <div class="bg-white rounded-lg shadow-sm p-4 border border-gray-100">
            <div class="text-xs text-gray-500">Catalog Merge</div>
            <div class="text-2xl font-semibold text-gray-900">
                {{ catalog.metrics.matched_extracted_count if catalog and catalog.metrics else 0 }}
            </div>
            <div class="text-xs text-gray-400 mt-1">Missing: {{ catalog.metrics.missing_extracted_count if catalog and catalog.metrics else 0 }}</div>
        </div>
        <div class="bg-white rounded-lg shadow-sm p-4 border border-gray-100">
            <div class="text-xs text-gray-500">QA Confidence</div>
            <div class="text-2xl font-semibold text-gray-900">
                {{ mapping.qa.confidence if mapping and mapping.qa else 0 }}
            </div>
            <div class="text-xs text-gray-400 mt-1">Ambiguous: {{ mapping.qa.stats.ambiguous_matches if mapping and mapping.qa else 0 }}</div>
        </div>
    </div>

    <!-- Warnings -->
    <div class="bg-white rounded-lg shadow-sm p-4 border border-gray-100">
        <div class="flex items-center justify-between">
            <h3 class="text-lg font-semibold text-gray-900">Mapping Warnings</h3>
            <span class="text-xs text-gray-400">Showing first 50</span>
        </div>
        {% if mapping and mapping.qa and mapping.qa.warnings and mapping.qa.warnings|length > 0 %}
        <div class="mt-3 max-h-64 overflow-y-auto text-sm">
            <ul class="list-disc pl-5 space-y-1 text-gray-700">
                {% for warning in mapping.qa.warnings[:50] %}
                <li>
                    {{ warning.message if warning.message is defined else warning }}
                </li>
                {% endfor %}
            </ul>
        </div>
        {% else %}
        <div class="mt-2 text-sm text-gray-500">No warnings from the mapper.</div>
        {% endif %}
    </div>

    <!-- Mapped Items -->
    <div class="bg-white rounded-lg shadow-sm border border-gray-100">
        <div class="px-4 py-3 border-b border-gray-100 flex items-center justify-between">
            <h3 class="text-lg font-semibold text-gray-900">Mapped Items</h3>
            <span class="text-xs text-gray-400">Showing first 200</span>
        </div>
        <div class="overflow-x-auto">
            <table class="min-w-[1100px] w-full text-sm">
                <thead class="bg-gray-50 text-gray-600">
                    <tr>
                        <th class="px-3 py-2 text-left">ID</th>
                        <th class="px-3 py-2 text-left">Label</th>
                        <th class="px-3 py-2 text-right">Qty</th>
                        <th class="px-3 py-2 text-center">UOM</th>
                        <th class="px-3 py-2 text-left">Source</th>
                        <th class="px-3 py-2 text-right">Confidence</th>
                        <th class="px-3 py-2 text-left">Provenance</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-100">
                    {% if mapping and mapping.bid_items %}
                        {% for item in mapping.bid_items[:200] %}
                        <tr class="hover:bg-gray-50">
                            <td class="px-3 py-2 font-mono text-xs text-gray-700">{{ item.id }}</td>
                            <td class="px-3 py-2">{{ item.label }}</td>
                            <td class="px-3 py-2 text-right">{{ item.qty }}</td>
                            <td class="px-3 py-2 text-center">{{ item.uom }}</td>
                            <td class="px-3 py-2 text-gray-600">{{ item.source_classification }}</td>
                            <td class="px-3 py-2 text-right">{{ item.confidence }}</td>
                            <td class="px-3 py-2 text-gray-600">
                                {{ item.provenance.sheet }} : {{ item.provenance.row }}
                            </td>
                        </tr>
                        {% endfor %}
                    {% else %}
                        <tr><td colspan="7" class="px-3 py-3 text-gray-500">No mapped items.</td></tr>
                    {% endif %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Unmapped Items -->
    <div class="bg-white rounded-lg shadow-sm border border-gray-100">
        <div class="px-4 py-3 border-b border-gray-100 flex items-center justify-between">
            <h3 class="text-lg font-semibold text-gray-900">Unmapped Items</h3>
            <span class="text-xs text-gray-400">Showing first 200</span>
        </div>
        <div class="overflow-x-auto">
            <table class="min-w-[900px] w-full text-sm">
                <thead class="bg-gray-50 text-gray-600">
                    <tr>
                        <th class="px-3 py-2 text-left">Classification</th>
                        <th class="px-3 py-2 text-left">Measures</th>
                        <th class="px-3 py-2 text-left">Provenance</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-100">
                    {% if mapping and mapping.unmapped %}
                        {% for item in mapping.unmapped[:200] %}
                        <tr class="hover:bg-gray-50">
                            <td class="px-3 py-2">{{ item.classification }}</td>
                            <td class="px-3 py-2 text-gray-600">
                                {% for m in item.measures %}
                                    {{ m.value }} {{ m.uom }} ({{ m.source }}){% if not loop.last %}, {% endif %}
                                {% endfor %}
                            </td>
                            <td class="px-3 py-2 text-gray-600">{{ item.provenance.sheet }} : {{ item.provenance.row }}</td>
                        </tr>
                        {% endfor %}
                    {% else %}
                        <tr><td colspan="3" class="px-3 py-3 text-gray-500">No unmapped items.</td></tr>
                    {% endif %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Catalog Missing Items -->
    <div class="bg-white rounded-lg shadow-sm border border-gray-100">
        <div class="px-4 py-3 border-b border-gray-100 flex items-center justify-between">
            <h3 class="text-lg font-semibold text-gray-900">Missing From Catalog</h3>
            <span class="text-xs text-gray-400">Showing first 200</span>
        </div>
        <div class="overflow-x-auto">
            <table class="min-w-[900px] w-full text-sm">
                <thead class="bg-gray-50 text-gray-600">
                    <tr>
                        <th class="px-3 py-2 text-left">ID</th>
                        <th class="px-3 py-2 text-left">Label</th>
                        <th class="px-3 py-2 text-right">Qty</th>
                        <th class="px-3 py-2 text-center">UOM</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-100">
                    {% if catalog and catalog.missing_items %}
                        {% for item in catalog.missing_items[:200] %}
                        <tr class="hover:bg-gray-50">
                            <td class="px-3 py-2 font-mono text-xs text-gray-700">{{ item.id }}</td>
                            <td class="px-3 py-2">{{ item.label }}</td>
                            <td class="px-3 py-2 text-right">{{ item.qty }}</td>
                            <td class="px-3 py-2 text-center">{{ item.uom }}</td>
                        </tr>
                        {% endfor %}
                    {% else %}
                        <tr><td colspan="4" class="px-3 py-3 text-gray-500">No catalog misses.</td></tr>
                    {% endif %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Normalized Rows -->
    <div class="bg-white rounded-lg shadow-sm border border-gray-100">
        <div class="px-4 py-3 border-b border-gray-100 flex items-center justify-between">
            <h3 class="text-lg font-semibold text-gray-900">Raw Rows (Normalized)</h3>
            <span class="text-xs text-gray-400">Showing first 200</span>
        </div>
        <div class="overflow-x-auto">
            <table class="min-w-[1100px] w-full text-xs">
                <thead class="bg-gray-50 text-gray-600">
                    <tr>
                        <th class="px-2 py-2 text-right">Row</th>
                        <th class="px-2 py-2 text-left">A</th>
                        <th class="px-2 py-2 text-left">B</th>
                        <th class="px-2 py-2 text-right">C</th>
                        <th class="px-2 py-2 text-right">D</th>
                        <th class="px-2 py-2 text-left">E</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-100">
                    {% if extraction.raw_rows %}
                        {% for row in extraction.raw_rows[:200] %}
                        <tr class="hover:bg-gray-50">
                            <td class="px-2 py-2 text-right text-gray-600">{{ row.row }}</td>
                            <td class="px-2 py-2">{{ row.A }}</td>
                            <td class="px-2 py-2">{{ row.B }}</td>
                            <td class="px-2 py-2 text-right">{{ row.C }}</td>
                            <td class="px-2 py-2 text-right">{{ row.D }}</td>
                            <td class="px-2 py-2">{{ row.E }}</td>
                        </tr>
                        {% endfor %}
                    {% else %}
                        <tr><td colspan="6" class="px-3 py-3 text-gray-500">No raw rows captured.</td></tr>
                    {% endif %}
                </tbody>
            </table>
        </div>
    </div>
</div>

{% else %}
<div class="bg-white rounded-lg shadow-sm p-6 text-gray-600">
    No debug payload available. Upload a file to populate extracted data.
</div>
{% endif %}
