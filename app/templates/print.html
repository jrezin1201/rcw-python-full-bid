{% extends "layout.html" %}

{% block title %}Proposal - {{ bid_state.project_name }}{% endblock %}
{% block page_title %}Print Preview{% endblock %}

{% block content %}
<style>
    @page {
        size: letter;
        margin: 0.75in;
    }
    @media print {
        body {
            background: white;
            -webkit-print-color-adjust: exact;
            print-color-adjust: exact;
        }
        .no-print { display: none !important; }
        body > div > div:first-child,
        header, .bg-blue-600 { display: none !important; }
        body > div > div:last-child { margin-left: 0 !important; }
        main { padding: 0 !important; }
        .print-page {
            max-width: 100%;
            margin: 0;
            padding: 0;
            box-shadow: none;
            border: none;
        }
        .page-break { page-break-before: always; }
        .avoid-break { page-break-inside: avoid; }
    }
    @media screen {
        .print-page {
            max-width: 8.5in;
            min-height: 11in;
            margin: 0 auto;
            padding: 0.75in;
            background: white;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            border: 1px solid #e5e7eb;
        }
    }
    /* Proposal typography */
    .proposal {
        font-family: Cambria, 'Palatino Linotype', Georgia, serif;
        font-size: 11pt;
        color: #000;
        line-height: 1.4;
    }
    .proposal table {
        border-collapse: collapse;
    }
    .proposal .b { font-weight: bold; }
    /* Header info table */
    .proposal .info-table {
        width: 100%;
        border: 1.5px solid #000;
    }
    .proposal .info-table td {
        padding: 3px 8px;
        font-size: 11pt;
        vertical-align: top;
    }
    .proposal .info-table .lbl {
        font-weight: bold;
        white-space: nowrap;
        width: 80px;
    }
    .proposal .info-left {
        border-right: 1.5px solid #000;
    }
    .proposal .info-row {
        border-bottom: 1px solid #ccc;
    }
    /* Project detail table */
    .proposal .proj-table {
        width: 100%;
        border: 1.5px solid #000;
    }
    .proposal .proj-table td {
        padding: 4px 8px;
        font-size: 11pt;
    }
    .proposal .proj-table .proj-lbl {
        font-weight: bold;
        white-space: nowrap;
        width: 70px;
    }
    .proposal .proj-table .proj-val {
        /* value cells stretch */
    }
    .proposal .proj-table .proj-plan-lbl {
        font-weight: bold;
        white-space: nowrap;
        text-align: left;
        width: 130px;
    }
    .proposal .proj-table .proj-plan-val {
        text-align: right;
        white-space: nowrap;
        width: 110px;
    }
    .proposal .proj-table .proj-divider {
        border-right: 1.5px solid #000;
    }
    .proposal .proj-table tr {
        border-bottom: 1px solid #ccc;
    }
    .proposal .proj-table tr:last-child {
        border-bottom: none;
    }
    /* Section titles */
    .proposal .section-title {
        font-weight: bold;
        font-size: 12pt;
        margin-top: 14px;
        margin-bottom: 3px;
        border-bottom: 1px solid #000;
        padding-bottom: 2px;
    }
    .proposal .scope-item {
        font-size: 11pt;
        padding: 1px 0 1px 12px;
    }
    .proposal .exclusion-item {
        font-size: 10pt;
        font-style: italic;
        color: #C00;
        padding: 1px 0 1px 12px;
    }
    /* Pricing */
    .proposal .pricing-box {
        border: 1.5px solid #000;
        margin-top: 20px;
    }
    .proposal .pricing-header {
        font-weight: bold;
        font-size: 13pt;
        text-align: center;
        padding: 4px 0;
        border-bottom: 1.5px solid #000;
        background: #f5f5f5;
    }
    .proposal table.pricing-table {
        width: 60%;
        margin: 8px auto;
    }
    .proposal table.pricing-table td {
        padding: 3px 12px;
        font-size: 11pt;
    }
    .proposal table.pricing-table tr.total-row {
        border-top: 1.5px solid #000;
        font-weight: bold;
        font-size: 12pt;
    }
    .proposal .net-wrap {
        font-style: italic;
        color: #C00;
        text-align: center;
        font-size: 10pt;
        padding: 4px 0 8px;
    }
    /* Exclusions */
    .proposal .excl-title {
        font-weight: bold;
        font-size: 12pt;
        color: #C00;
        text-align: center;
        border-bottom: 1px solid #C00;
        padding-bottom: 2px;
        margin-bottom: 6px;
    }
    .proposal .excl-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1px 24px;
        font-size: 10pt;
    }
    .proposal .excl-grid p {
        margin: 0;
        padding: 1px 0;
    }
    /* Alternates */
    .proposal .alt-header {
        font-weight: bold;
        font-size: 12pt;
        text-align: center;
        border-bottom: 1.5px solid #000;
        padding-bottom: 2px;
        margin-bottom: 4px;
    }
    /* Materials */
    .proposal .mat-title {
        font-weight: bold;
        font-size: 11pt;
    }
    .proposal .mat-section-title {
        font-weight: bold;
        font-size: 11pt;
        padding: 3px 0 1px 0;
    }
    .proposal .mat-item td {
        padding: 1px 0 1px 16px;
        font-size: 11pt;
    }
    .proposal .mat-item td:nth-child(2) {
        padding-left: 24px;
    }
    /* Signatures */
    .proposal .sig-line {
        border-bottom: 1px solid #000;
        height: 32px;
        margin-top: 4px;
    }
    .proposal .highlight-yellow {
        background-color: #FFFF00;
        font-weight: bold;
        padding: 0 4px;
    }
</style>

<div class="print-page proposal" id="print-content">

    <!-- HEADER: Developer/Address/City + Date/Contact/Phone/Email -->
    <div class="avoid-break" style="margin-bottom: 12px;">
        <table class="info-table">
            <tr class="info-row">
                <td class="lbl info-left">Developer:</td>
                <td class="info-left">{{ project_info.developer or '' }}</td>
                <td class="lbl">Date:</td>
                <td>{{ today_date }}</td>
            </tr>
            <tr class="info-row">
                <td class="lbl info-left">Address:</td>
                <td class="info-left">{{ project_info.address or '' }}</td>
                <td class="lbl">Contact:</td>
                <td>{{ project_info.contact or '' }}</td>
            </tr>
            <tr>
                <td class="lbl info-left">City:</td>
                <td class="info-left">{{ project_info.city or '' }}</td>
                <td class="lbl">Phone:</td>
                <td>{{ project_info.phone or '' }}</td>
            </tr>
        </table>
    </div>

    <!-- PROJECT INFO TABLE -->
    <div class="avoid-break" style="margin-bottom: 16px;">
        <table class="proj-table">
            <tr>
                <td class="proj-lbl proj-divider">PROJECT</td>
                <td class="proj-val proj-divider">{{ bid_state.project_name or '' }}</td>
                <td class="proj-plan-lbl">PLANS</td>
                <td class="b" style="text-align: center;">DATED</td>
            </tr>
            <tr>
                <td class="proj-lbl proj-divider">UNITS</td>
                <td class="proj-val proj-divider">{{ project_info.units_text or '' }}</td>
                <td class="proj-plan-lbl">ARCHITECTURAL</td>
                <td class="proj-plan-val">{{ (project_info.arch_date or '')|fmt_date }}</td>
            </tr>
            <tr>
                <td class="proj-lbl proj-divider">CITY</td>
                <td class="proj-val proj-divider">{{ project_info.project_city or '' }}</td>
                <td class="proj-plan-lbl">LANDSCAPE</td>
                <td class="proj-plan-val">
                    {% set ld = (project_info.landscape_date or '')|fmt_date %}
                    {% if ld and ld.lower() != 'excluded' %}
                        {{ ld }}
                    {% else %}
                        <span style="color: #C00;">Excluded</span>
                    {% endif %}
                </td>
            </tr>
            <tr>
                <td class="proj-lbl proj-divider"></td>
                <td class="proj-val proj-divider"></td>
                <td class="proj-plan-lbl">INTERIOR DESIGN</td>
                <td class="proj-plan-val">{{ (project_info.interior_design_date or '')|fmt_date }}</td>
            </tr>
            <tr>
                <td class="proj-lbl proj-divider"></td>
                <td class="proj-val proj-divider"></td>
                <td class="proj-plan-lbl" style="font-size: 10pt;">OWNER SPECS</td>
                <td class="proj-plan-val">{{ (project_info.owner_specs_date or '')|fmt_date or 'NA' }}</td>
            </tr>
        </table>
    </div>

    <!-- SCOPE SECTIONS -->
    {% for section_name in sections %}
    {% set all_section_items = sections_data[section_name] %}
    {% set active_items = all_section_items | rejectattr('excluded') | rejectattr('is_exclusion') | rejectattr('is_alternate') | selectattr('qty') | list %}
    {% set exclusion_items = all_section_items | selectattr('is_exclusion') | list %}
    {% if active_items or exclusion_items %}
    <div class="avoid-break" style="margin-bottom: 4px;">
        <div class="section-title">{{ section_name|upper }}</div>
        {% for item in active_items %}
        <div class="scope-item">{{ item.name }}</div>
        {% endfor %}
        {% for item in exclusion_items %}
        <div class="exclusion-item">Excludes {{ item.name }}</div>
        {% endfor %}
    </div>
    {% endif %}
    {% endfor %}

    <!-- PRICING SECTION -->
    <div class="avoid-break pricing-box" style="margin-bottom: 16px;">
        <div class="pricing-header">PRICING</div>
        <table class="pricing-table">
            <tr>
                <td></td>
                <td style="font-weight: bold; text-align: center; border-bottom: 1px solid #ccc;">Amount</td>
            </tr>
            {% for section in bid_state.section_totals %}
            {% if section.total > 0 %}
            <tr>
                <td>{{ section.section_name|capitalize }}</td>
                <td style="text-align: right;">{{ "${:,.2f}".format(section.total) }}</td>
            </tr>
            {% endif %}
            {% endfor %}
            <tr class="total-row">
                <td>Total</td>
                <td style="text-align: right;">{{ "${:,.2f}".format(bid_state.grand_total) }}</td>
            </tr>
        </table>
        <div class="net-wrap">Pricing Net Wrap Liability Insurance</div>
    </div>

    <!-- EXCLUSIONS -->
    <div class="avoid-break" style="margin-bottom: 16px;">
        <div class="excl-title">EXCLUSIONS</div>
        <div class="excl-grid">
            <div>
                <p class="highlight-yellow">9900 Specifications</p>
                <p>0 VOC Paints &amp; Systems</p>
                <p>Scaffolding &amp; Lifts</p>
                <p>Saturday &amp; Weekend Work</p>
                <p>Water Proofing Membranes</p>
                <p>ALL Exterior Caulking: Done By Other</p>
                <p>Power &amp; Pressure Washing</p>
                <p>Signing Unmodified Scaffold Agreements</p>
            </div>
            <div>
                <p>Masked Hinges</p>
                <p>ALL Stand Pipes</p>
                <p>Wall Coverings</p>
                <p>Paid Parking: Parking To Be Provided By Contractor</p>
                <p>Caulking Windows: By Drywall Contractor</p>
                <p>Not Responsible For Rusting If Metal Is Not Metalized</p>
                <p>Payment &amp; Performance Bonds</p>
                <p>Excess &amp; Umbrella Coverages</p>
            </div>
        </div>
    </div>

    <!-- ADD ALTERNATES -->
    {% if alternates|length > 0 %}
    <div class="avoid-break" style="margin-bottom: 16px;">
        <div class="alt-header">ADD ALTERNATES</div>
        <table style="width: 60%; margin: 0 auto;">
            {% for alt in alternates %}
            <tr>
                <td style="padding: 3px 8px;">{{ alt.name }}</td>
                <td style="padding: 3px 8px; text-align: right;">{{ "${:,.2f}".format(alt.row_total) }}</td>
            </tr>
            {% endfor %}
        </table>
    </div>
    {% endif %}

    <!-- ADDITIONAL WORK RATES -->
    <div class="avoid-break" style="margin-bottom: 16px;">
        <table>
            <tr>
                <td class="b" style="padding-right: 24px;">ADDITIONAL WORK CHARGED AT:</td>
                <td>$73.00/HR</td>
            </tr>
            <tr>
                <td class="b" style="padding-right: 24px;">1/2 Time OT Work</td>
                <td>$37.00/HR</td>
            </tr>
        </table>
    </div>

    <!-- MATERIALS INCLUDED IN BID (dynamic) -->
    {% if materials_section_order %}
    <div class="avoid-break" style="margin-bottom: 20px;">
        <div class="mat-title" style="margin-bottom: 4px;">MATERIALS INCLUDED IN BID: {{ materials_brand }}</div>
        <table>
            {% for section_label in materials_section_order %}
            {% set mat_items = materials_sections.get(section_label, []) %}
            <tr><td class="mat-section-title" colspan="2">{{ section_label }}</td></tr>
            {% for item in mat_items %}
            <tr class="mat-item">
                <td style="width: 140px;">{{ item.name }}</td>
                <td>{{ item.value }}</td>
            </tr>
            {% endfor %}
            {% endfor %}
        </table>
    </div>
    {% endif %}

    <!-- SIGNATURE SECTION -->
    <div class="avoid-break" style="margin-top: 32px;">
        <p style="font-size: 10pt; margin-bottom: 16px;">This proposal is valid for 30 days from the date above.</p>
        <table style="width: 100%;">
            <tr>
                <td style="width: 46%; vertical-align: top;">
                    <p style="font-size: 10pt; margin-bottom: 2px;">Authorized Signature - RCW Painting</p>
                    <div class="sig-line"></div>
                    <p style="font-size: 10pt; margin-top: 4px;">Date: _____________</p>
                </td>
                <td style="width: 8%;"></td>
                <td style="width: 46%; vertical-align: top;">
                    <p style="font-size: 10pt; margin-bottom: 2px;">Acceptance - Customer</p>
                    <div class="sig-line"></div>
                    <p style="font-size: 10pt; margin-top: 4px;">Date: _____________</p>
                </td>
            </tr>
        </table>
    </div>

    <!-- FOOTER -->
    <div style="margin-top: 24px; text-align: center; font-size: 9pt; color: #888; border-top: 1px solid #ccc; padding-top: 8px;">
        RCW Painting | {{ today_date }}
    </div>
</div>

<!-- Print Controls (hidden when printing) -->
<div class="fixed bottom-8 right-8 no-print flex gap-2">
    <button onclick="window.print()"
            class="px-6 py-3 bg-blue-600 text-white rounded-lg shadow-lg hover:bg-blue-700 transition flex items-center">
        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"></path>
        </svg>
        Print / Save PDF
    </button>
    <a href="/bid" class="px-6 py-3 bg-gray-600 text-white rounded-lg shadow-lg hover:bg-gray-700 transition inline-flex items-center">
        Back to Bid Form
    </a>
</div>
{% endblock %}
