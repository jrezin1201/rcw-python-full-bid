{% extends "layout.html" %}

{% block title %}Spec Form - {{ bid_state.project_name }}{% endblock %}
{% block page_title %}Spec Form{% endblock %}

{% block header %}
<div class="flex justify-between items-center">
    <div>
        <h2 class="text-xl font-bold text-slate-900">Spec Form</h2>
        <p class="text-xs text-slate-500 mt-0.5">{{ bid_state.project_name }}</p>
    </div>
    <div class="flex gap-2">
        <a href="/spec/export?format=xlsx"
           class="px-3 py-1.5 text-xs bg-white text-slate-600 border border-slate-200 rounded hover:bg-slate-50 transition">
            Export XLSX
        </a>
        <a href="/spec/export?format=pdf"
           class="px-3 py-1.5 text-xs bg-slate-800 text-white rounded hover:bg-slate-700 transition">
            Export PDF
        </a>
    </div>
</div>
{% endblock %}

{% block content %}
<div class="max-w-5xl mx-auto space-y-3">

    <!-- Summary Strip -->
    <div class="relative bg-white border border-slate-200 rounded-lg px-5 py-2 flex items-center gap-6 overflow-hidden">
        <div class="absolute left-0 top-0 h-full w-1 bg-slate-800/20"></div>
        <div class="flex items-center gap-1.5">
            <span class="text-[11px] uppercase tracking-wide text-slate-500">Sections</span>
            <span class="text-sm font-semibold text-slate-900 tabular-nums">{{ ordered_section_totals|length }}</span>
        </div>
        <div class="w-px h-4 bg-slate-200"></div>
        <div class="flex items-center gap-1.5">
            <span class="text-[11px] uppercase tracking-wide text-slate-500">Grand Total</span>
            <span class="text-sm font-semibold text-slate-900 tabular-nums">{{ format_currency(bid_state.grand_total) }}</span>
        </div>
    </div>

    <!-- Spec Sections -->
    {% for section_total in ordered_section_totals %}
    {% set section_name = section_total.section_name %}
    {% set section_spec_items = bid_state.spec_items.get(section_name, []) %}
    {% set section_label = bid_state.spec_section_labels.get(section_name, '') %}
    {% set section_id = section_name | replace(' ', '-') | replace('/', '-') %}
    <div class="bg-white border border-slate-200 rounded-lg overflow-hidden">
        <!-- Section Header -->
        <div id="spec-header-{{ section_id }}" class="bg-slate-100 border-b border-slate-200 px-4 py-2.5 flex justify-between items-center">
            <div class="flex items-center gap-2.5 min-w-0">
                <span class="inline-flex h-6 w-6 items-center justify-center rounded-md bg-white border border-slate-200 text-xs font-semibold text-slate-700 shrink-0">{{ loop.index }}</span>
                <span class="font-semibold text-sm text-slate-900 shrink-0">{{ section_name }}</span>
                <span class="text-xs text-slate-500 shrink-0">{{ section_total.item_count }} items</span>

                {% if section_label %}
                <span class="ml-1 px-2.5 py-0.5 bg-blue-50 text-blue-700 font-semibold text-[10px] uppercase rounded tracking-wide shrink-0 border border-blue-200">{{ section_label }}</span>
                {% endif %}
            </div>

            <div class="flex items-center gap-3 shrink-0" x-data="{
                mode: '{{ 'preset' if section_label == 'Flat One Tone' else ('custom' if section_label else 'blank') }}',
                customText: '{{ section_label if section_label and section_label != 'Flat One Tone' else '' }}'
            }">
                <select
                    class="h-8 bg-white text-slate-700 text-sm rounded-md border border-slate-200 px-2 focus:ring-1 focus:ring-blue-500"
                    @change="
                        if ($event.target.value === '') {
                            mode = 'blank';
                            customText = '';
                            $refs.labelForm.querySelector('[name=label]').value = '';
                            htmx.trigger($refs.labelForm, 'submit');
                        } else if ($event.target.value === 'Flat One Tone') {
                            mode = 'preset';
                            customText = '';
                            $refs.labelForm.querySelector('[name=label]').value = 'Flat One Tone';
                            htmx.trigger($refs.labelForm, 'submit');
                        } else if ($event.target.value === '__custom__') {
                            mode = 'custom';
                            $nextTick(() => $refs.customInput.focus());
                        }
                    "
                >
                    <option value="" {{ 'selected' if not section_label }}>-- Label --</option>
                    <option value="Flat One Tone" {{ 'selected' if section_label == 'Flat One Tone' }}>Flat One Tone</option>
                    <option value="__custom__" {{ 'selected' if section_label and section_label != 'Flat One Tone' }}>Custom...</option>
                </select>

                <template x-if="mode === 'custom'">
                    <div class="flex items-center gap-1">
                        <input type="text" x-ref="customInput" x-model="customText" placeholder="Enter label"
                               class="h-8 bg-white text-slate-700 text-sm rounded-md border border-slate-200 px-2 w-28 focus:ring-1 focus:ring-blue-500">
                        <button type="button"
                                class="text-xs bg-slate-800 text-white px-2 py-1.5 rounded-md hover:bg-slate-700"
                                @click="
                                    $refs.labelForm.querySelector('[name=label]').value = customText;
                                    htmx.trigger($refs.labelForm, 'submit');
                                ">Set</button>
                    </div>
                </template>

                <form x-ref="labelForm" class="hidden"
                      hx-post="/spec/section/label"
                      hx-target="#spec-header-{{ section_id }}"
                      hx-swap="innerHTML">
                    <input type="hidden" name="section" value="{{ section_name }}">
                    <input type="hidden" name="label" value="">
                </form>

                <span class="w-28 text-right font-semibold text-sm text-slate-900 tabular-nums">{{ format_currency(section_total.total) }}</span>
            </div>
        </div>

        <!-- Spec Items Table -->
        <table class="w-full">
            <thead>
                <tr class="bg-slate-50 text-[11px] font-semibold uppercase tracking-wide text-slate-600 border-b border-slate-200">
                    <th class="px-4 py-2 text-center w-10">#</th>
                    <th class="px-2 py-2 text-center w-12"></th>
                    <th class="px-4 py-2 text-left">Spec Item</th>
                    <th class="px-4 py-2 text-right w-28">Price</th>
                    <th class="px-4 py-2 text-center w-10"></th>
                </tr>
            </thead>
            <tbody id="spec-body-{{ section_id }}">
                {% for spec in section_spec_items %}
                <tr class="{{ 'bg-red-50/50' if spec.excluded else 'odd:bg-white even:bg-slate-50/30' }} border-b border-slate-200/60 hover:bg-slate-100/60 transition-colors">
                    <td class="px-4 py-3 text-center text-[10px] text-slate-400 font-mono w-10">{{ loop.index }}</td>
                    <td class="px-2 py-3 text-center w-12">
                        <form hx-post="/spec/item/exclude"
                              hx-target="#spec-body-{{ section_id }}"
                              hx-swap="innerHTML">
                            <input type="hidden" name="section" value="{{ section_name }}">
                            <input type="hidden" name="index" value="{{ loop.index0 }}">
                            <button type="submit"
                                    class="inline-flex h-7 w-7 items-center justify-center rounded-md text-xs font-bold transition {{ 'bg-red-700 text-white' if spec.excluded else 'bg-slate-200/70 text-slate-700 hover:bg-indigo-50 hover:text-indigo-700' }}"
                                    title="{{ 'Include' if spec.excluded else 'Exclude' }}">
                                E
                            </button>
                        </form>
                    </td>
                    <td class="px-4 py-3 text-sm {{ 'text-slate-400' if spec.excluded else 'text-slate-800' }}">
                        <form hx-post="/spec/item/name"
                              hx-target="#spec-body-{{ section_id }}"
                              hx-swap="innerHTML"
                              hx-trigger="change"
                              class="flex items-center">
                            <input type="hidden" name="section" value="{{ section_name }}">
                            <input type="hidden" name="index" value="{{ loop.index0 }}">
                            <input type="text" name="name" value="{{ spec.name }}"
                                   class="w-full bg-transparent border-b border-transparent hover:border-slate-300 focus:border-blue-500 focus:outline-none focus:bg-white px-1 py-0.5 text-sm {{ 'line-through text-slate-400' if spec.excluded else 'text-slate-800' }}">
                        </form>
                        {% if spec.excluded %}
                        <span class="ml-1 text-red-700 font-semibold text-[10px] uppercase">Excluded</span>
                        {% endif %}
                    </td>
                    <td class="px-4 py-3 text-right w-28">
                        <form hx-post="/spec/item/price"
                              hx-target="#spec-body-{{ section_id }}"
                              hx-swap="innerHTML"
                              hx-trigger="change">
                            <input type="hidden" name="section" value="{{ section_name }}">
                            <input type="hidden" name="index" value="{{ loop.index0 }}">
                            <input type="text" name="price"
                                   value="{{ '${:,.2f}'.format(spec.price) if spec.price else '' }}"
                                   placeholder="—"
                                   class="w-24 px-1 py-0.5 text-right text-sm text-slate-400 bg-transparent border-b border-transparent hover:border-slate-300 focus:border-blue-500 focus:outline-none focus:bg-white focus:text-slate-700 tabular-nums">
                        </form>
                    </td>
                    <td class="px-4 py-3 text-center w-10">
                        <form hx-post="/spec/item/delete"
                              hx-target="#spec-body-{{ section_id }}"
                              hx-swap="innerHTML">
                            <input type="hidden" name="section" value="{{ section_name }}">
                            <input type="hidden" name="index" value="{{ loop.index0 }}">
                            <button type="submit"
                                    class="text-slate-300 hover:text-rose-500 transition-colors"
                                    title="Delete">
                                <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                                </svg>
                            </button>
                        </form>
                    </td>
                </tr>
                {% endfor %}

                <!-- Add Item Row -->
                <tr class="bg-slate-50/50" x-data="{ showAdd: false }">
                    <td colspan="5" class="px-4 py-2">
                        <div x-show="!showAdd">
                            <button type="button" @click="showAdd = true"
                                    class="text-xs text-slate-500 hover:text-slate-700 flex items-center gap-1">
                                <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                                </svg>
                                Add Spec Item
                            </button>
                        </div>
                        <div x-show="showAdd" x-cloak>
                            <form class="flex items-center gap-2"
                                  hx-post="/spec/item/add"
                                  hx-target="#spec-body-{{ section_id }}"
                                  hx-swap="innerHTML"
                                  @htmx:after-request="showAdd = false">
                                <input type="hidden" name="section" value="{{ section_name }}">
                                <input type="text" name="name" required placeholder="Spec item description"
                                       class="flex-1 px-2 py-1.5 text-sm border border-slate-300 rounded focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500">
                                <button type="submit"
                                        class="px-3 py-1.5 bg-slate-800 text-white text-xs rounded hover:bg-slate-700">
                                    Add
                                </button>
                                <button type="button" @click="showAdd = false"
                                        class="px-3 py-1.5 bg-slate-100 text-slate-600 text-xs rounded hover:bg-slate-200">
                                    Cancel
                                </button>
                            </form>
                        </div>
                    </td>
                </tr>
            </tbody>
        </table>

    </div>
    {% endfor %}

    <!-- Normal Exclusions -->
    <div class="bg-white border border-slate-200 rounded-lg overflow-hidden">
        <div class="bg-amber-50 border-b border-amber-100 px-4 py-2 flex items-center justify-between">
            <span class="text-sm font-semibold text-amber-900">NORMAL EXCLUSIONS</span>
            <span class="text-xs text-amber-700 tabular-nums">{{ bid_state.spec_exclusions|length }} items</span>
        </div>
        <div class="p-4" id="spec-exclusions-body">
            {% set exclusions = bid_state.spec_exclusions %}
            {% include "partials/spec_exclusions_body.html" %}
        </div>
    </div>

    <!-- Add Alts Section -->
    <div class="bg-white border border-slate-200 rounded-lg overflow-hidden">
        <div class="bg-slate-100 border-b border-slate-200 px-4 py-2 flex justify-between items-center">
            <span class="font-semibold text-sm text-slate-700">ADD ALTS</span>
            <span class="text-xs text-slate-500">Excluded spec items appear here</span>
        </div>
        <div id="spec-add-alts"
             hx-get="/spec/add-alts"
             hx-trigger="add-alts-updated from:body"
             hx-swap="innerHTML">
            {% include "partials/spec_add_alts.html" %}
        </div>
    </div>

    <!-- Materials Included in Bid -->
    <div class="bg-white border border-slate-200 rounded-lg overflow-hidden">
        <div class="bg-slate-100 border-b border-slate-200 px-4 py-2 flex justify-between items-center">
            <span class="font-semibold text-sm text-slate-700">MATERIALS INCLUDED IN BID</span>
            <span class="text-xs text-slate-500">{{ materials_brand }}</span>
        </div>
        <div class="py-3" id="spec-materials-body">
            {% include "partials/spec_materials_body.html" %}
        </div>
    </div>

</div>
{% endblock %}

{% block scripts %}
<script>
(function() {
    // Track dirty material inputs
    document.addEventListener('input', function(e) {
        if (e.target.closest('#spec-materials-body') && e.target.matches('input[type="text"]')) {
            e.target.dataset.dirty = 'true';
        }
    });

    // Flush all dirty material inputs synchronously via XMLHttpRequest
    function flushDirtyInputs(exclude) {
        var dirtyInputs = document.querySelectorAll('#spec-materials-body input[data-dirty="true"]');
        dirtyInputs.forEach(function(input) {
            if (exclude && exclude.contains(input)) return;
            var form = input.closest('form');
            if (!form) return;
            var url = form.getAttribute('hx-post');
            if (!url) return;
            var xhr = new XMLHttpRequest();
            xhr.open('POST', url, false); // synchronous
            xhr.send(new FormData(form));
            input.dataset.dirty = 'false';
        });
    }

    // Before any HTMX request that will re-render #spec-materials-body, flush dirty inputs
    document.body.addEventListener('htmx:before-request', function(e) {
        var elt = e.detail.elt;
        var swap = elt.getAttribute('hx-swap');
        // Only intercept requests that will swap content (not hx-swap="none" auto-saves)
        if (swap === 'none') return;
        var target = elt.getAttribute('hx-target');
        if (target === '#spec-materials-body') {
            flushDirtyInputs(elt);
        }
    });

    // Intercept navigation links — save dirty material inputs first, then navigate
    document.addEventListener('click', function(e) {
        var link = e.target.closest('a[href]');
        if (!link) return;
        var dirtyInputs = document.querySelectorAll('#spec-materials-body input[data-dirty="true"]');
        if (dirtyInputs.length === 0) return;
        flushDirtyInputs(null);
        // No need to prevent/delay — sync XHR already completed
    });
})();
</script>
{% endblock %}
